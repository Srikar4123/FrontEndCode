<div class="manage-books">
  <!-- Header -->
  <header class="header">
    <h2>Manage Books</h2>
    <div class="actions">
      <button type="button" class="btn primary" (click)="toggleCreate()">
        {{ showCreate ? 'Close Add Book' : 'Add Book' }}
      </button>
    </div>
  </header>

  <!-- Genre Filter -->
  <section class="filter">
    <div class="filter-row">
      <label for="genreInput">Filter by Genre:</label>
      <input
        id="genreInput"
        type="text"
        placeholder="e.g. Fiction"
        [(ngModel)]="genre"
        name="genre"
      />

      <!-- optional presets -->
      <select [(ngModel)]="genre" name="genrePreset">
        <option value="">— Presets —</option>
        <option *ngFor="let g of genresPreset" [value]="g">{{ g }}</option>
      </select>

      <button type="button" class="btn" (click)="load()">Apply</button>
      <button type="button" class="btn secondary" (click)="clearFilter()">Clear</button>
    </div>
  </section>

  <!-- Create Form -->
  <section class="create" *ngIf="showCreate">
    <form [formGroup]="createForm" (ngSubmit)="submitCreate()" novalidate>
      <fieldset>
        <legend>Add New Book</legend>

        <div class="grid-2">
          <!-- Title -->
          <div class="form-field">
            <label>Title <span class="req">*</span></label>
            <input type="text" formControlName="title" />
            <div
              class="error"
              *ngIf="
                createForm.get('title')?.touched && createForm.get('title')?.hasError('required')
              "
            >
              Title is required.
            </div>
          </div>

          <!-- Author -->
          <div class="form-field">
            <label>Author <span class="req">*</span></label>
            <input type="text" formControlName="author" />
            <div
              class="error"
              *ngIf="
                createForm.get('author')?.touched && createForm.get('author')?.hasError('required')
              "
            >
              Author is required.
            </div>
          </div>

          <!-- Genre -->
          <div class="form-field">
            <label>Genre <span class="req">*</span></label>
            <input type="text" formControlName="genre" />
            <div
              class="error"
              *ngIf="
                createForm.get('genre')?.touched && createForm.get('genre')?.hasError('required')
              "
            >
              Genre is required.
            </div>
          </div>

          <!-- Price -->
          <div class="form-field">
            <label>Price (₹) <span class="req">*</span></label>
            <input type="number" formControlName="price" min="0" step="0.01" />
            <div
              class="error"
              *ngIf="createForm.get('price')?.touched && createForm.get('price')?.hasError('min')"
            >
              Price cannot be negative.
            </div>
            <div
              class="error"
              *ngIf="
                createForm.get('price')?.touched && createForm.get('price')?.hasError('required')
              "
            >
              Price is required.
            </div>
          </div>

          <!-- Total Copies -->
          <div class="form-field">
            <label>Total Copies <span class="req">*</span></label>
            <input type="number" formControlName="totalCopies" min="0" />
            <div
              class="error"
              *ngIf="
                createForm.get('totalCopies')?.touched &&
                createForm.get('totalCopies')?.hasError('min')
              "
            >
              Total copies cannot be negative.
            </div>
            <div
              class="error"
              *ngIf="
                createForm.get('totalCopies')?.touched &&
                createForm.get('totalCopies')?.hasError('required')
              "
            >
              Total copies is required.
            </div>
          </div>

          <!-- Available Copies -->
          <div class="form-field">
            <label>Available Copies <span class="req">*</span></label>
            <input type="number" formControlName="availableCopies" min="0" />
            <div
              class="error"
              *ngIf="
                createForm.get('availableCopies')?.touched &&
                createForm.get('availableCopies')?.hasError('min')
              "
            >
              Available copies cannot be negative.
            </div>
            <div
              class="error"
              *ngIf="
                createForm.get('availableCopies')?.touched &&
                createForm.get('availableCopies')?.hasError('required')
              "
            >
              Available copies is required.
            </div>
          </div>

          <!-- Image URL -->
          <div class="form-field">
            <label>Image URL</label>
            <input type="url" formControlName="imageUrl" />
          </div>

          <!-- Description -->
          <div class="form-field span-2">
            <label>Description</label>
            <textarea rows="3" formControlName="description"></textarea>
          </div>
        </div>

        <!-- Cross-field validator error -->
        <div class="error" *ngIf="createForm.touched && createForm.hasError('copiesRange')">
          Available copies cannot exceed total copies.
        </div>

        <div class="form-actions">
          <button type="submit" class="btn primary" [disabled]="createForm.invalid">Create</button>
          <button type="button" class="btn secondary" (click)="toggleCreate()">Cancel</button>
        </div>
      </fieldset>
    </form>
  </section>

  <!-- Loading state -->
  <section *ngIf="loading" class="loading">Loading books…</section>

  <!-- Table of books -->
  <section *ngIf="!loading">
    <table class="table">
      <thead>
        <tr>
          <th>#</th>
          <th>Cover</th>
          <th>Title</th>
          <th>Author</th>
          <th>Genre</th>
          <th>Price</th>
          <th>Copies (Avail/Total)</th>
          <th>Description</th>
          <th style="width: 180px">Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let b of books; trackBy: trackById">
          <td>{{ b.id }}</td>

          <!-- Image -->
          <td>
            <img
              *ngIf="b.imageUrl; else noImage"
              [src]="b.imageUrl!"
              alt="{{ b.title }}"
              class="cover"
              (error)="b.imageUrl = null"
            />
            <ng-template #noImage>
              <span class="muted">No image</span>
            </ng-template>
          </td>

          <!-- If editing this row, show inline edit form cells -->
          <ng-container *ngIf="editingId === b.id; else viewRow">
            <!-- Inline Edit Form -->
            <td colspan="7">
              <form
                *ngIf="editingForm"
                [formGroup]="editingForm"
                (ngSubmit)="saveEdit(b.id)"
                novalidate
              >
                <div class="grid-2">
                  <!-- Title -->
                  <div class="form-field">
                    <label>Title <span class="req">*</span></label>
                    <input type="text" formControlName="title" />
                    <div
                      class="error"
                      *ngIf="
                        editingForm?.get('title')?.touched &&
                        editingForm?.get('title')?.hasError('required')
                      "
                    >
                      Title is required.
                    </div>
                  </div>

                  <!-- Author -->
                  <div class="form-field">
                    <label>Author <span class="req">*</span></label>
                    <input type="text" formControlName="author" />
                    <div
                      class="error"
                      *ngIf="
                        editingForm?.get('author')?.touched &&
                        editingForm?.get('author')?.hasError('required')
                      "
                    >
                      Author is required.
                    </div>
                  </div>

                  <!-- Genre -->
                  <div class="form-field">
                    <label>Genre <span class="req">*</span></label>
                    <input type="text" formControlName="genre" />
                    <div
                      class="error"
                      *ngIf="
                        editingForm?.get('genre')?.touched &&
                        editingForm?.get('genre')?.hasError('required')
                      "
                    >
                      Genre is required.
                    </div>
                  </div>

                  <!-- Price -->
                  <div class="form-field">
                    <label>Price (₹) <span class="req">*</span></label>
                    <input type="number" formControlName="price" min="0" step="0.01" />
                    <div
                      class="error"
                      *ngIf="
                        editingForm?.get('price')?.touched &&
                        editingForm?.get('price')?.hasError('min')
                      "
                    >
                      Price cannot be negative.
                    </div>
                    <div
                      class="error"
                      *ngIf="
                        editingForm?.get('price')?.touched &&
                        editingForm?.get('price')?.hasError('required')
                      "
                    >
                      Price is required.
                    </div>
                  </div>

                  <!-- Total Copies -->
                  <div class="form-field">
                    <label>Total Copies <span class="req">*</span></label>
                    <input type="number" formControlName="totalCopies" min="0" />
                    <div
                      class="error"
                      *ngIf="
                        editingForm?.get('totalCopies')?.touched &&
                        editingForm?.get('totalCopies')?.hasError('min')
                      "
                    >
                      Total copies cannot be negative.
                    </div>
                    <div
                      class="error"
                      *ngIf="
                        editingForm?.get('totalCopies')?.touched &&
                        editingForm?.get('totalCopies')?.hasError('required')
                      "
                    >
                      Total copies is required.
                    </div>
                  </div>

                  <!-- Available Copies -->
                  <div class="form-field">
                    <label>Available Copies <span class="req">*</span></label>
                    <input type="number" formControlName="availableCopies" min="0" />
                    <div
                      class="error"
                      *ngIf="
                        editingForm?.get('availableCopies')?.touched &&
                        editingForm?.get('availableCopies')?.hasError('min')
                      "
                    >
                      Available copies cannot be negative.
                    </div>
                    <div
                      class="error"
                      *ngIf="
                        editingForm?.get('availableCopies')?.touched &&
                        editingForm?.get('availableCopies')?.hasError('required')
                      "
                    >
                      Available copies is required.
                    </div>
                  </div>

                  <!-- Image URL -->
                  <div class="form-field">
                    <label>Image URL</label>
                    <input type="url" formControlName="imageUrl" />
                  </div>

                  <!-- Description -->
                  <div class="form-field span-2">
                    <label>Description</label>
                    <textarea rows="3" formControlName="description"></textarea>
                  </div>
                </div>

                <!-- Cross-field validator error -->
                <div
                  class="error"
                  *ngIf="editingForm?.touched && editingForm?.hasError('copiesRange')"
                >
                  Available copies cannot exceed total copies.
                </div>

                <div class="form-actions">
                  <button type="submit" class="btn primary" [disabled]="editingForm?.invalid">
                    Save
                  </button>
                  <button type="button" class="btn secondary" (click)="cancelEdit()">Cancel</button>
                </div>
              </form>
            </td>

            <!-- Actions column while editing -->
            <td>
              <button class="btn danger" (click)="delete(b)">Delete</button>
            </td>
          </ng-container>

          <!-- View row (non-editing) -->
          <ng-template #viewRow>
            <td>{{ b.title }}</td>
            <td>{{ b.author }}</td>
            <td>{{ b.genre }}</td>
            <td>₹ {{ b.price | number : '1.2-2' }}</td>
            <td>{{ b.availableCopies }} / {{ b.totalCopies }}</td>
            <td>
              <span class="desc" [title]="b.description">{{ b.description || '—' }}</span>
            </td>
            <td>
              <div class="row-actions">
                <button class="btn" (click)="startEdit(b)">Edit</button>
                <button class="btn danger" (click)="delete(b)">Delete</button>
              </div>
            </td>
          </ng-template>
        </tr>

        <!-- Empty state -->
        <tr *ngIf="!loading && books.length === 0">
          <td colspan="9" class="muted center">No books found.</td>
        </tr>
      </tbody>
    </table>
  </section>
</div>
